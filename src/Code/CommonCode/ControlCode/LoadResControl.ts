
//#region ////___AUTO_CONFIG_START___////
export const ResPath = {
    "刹车.mp3":"res/sounds/刹车.mp3",
    "喇叭.mp3":"res/sounds/喇叭.mp3",
    "引擎.mp3":"res/sounds/引擎.mp3",
    "背景音乐2.mp3":"res/sounds/背景音乐2.mp3",
    "SampleSceneGIReflection.ltcb.ls":"res/3DScene/LayaScene_SampleScene/Conventional/Assets/SampleSceneGIReflection.ltcb.ls",
    "SampleScene.ls":"res/3DScene/LayaScene_SampleScene/Conventional/SampleScene.ls",
    "Cube.lh":"res/3DScene/LayaScene_SampleScene/Conventional/Cube.lh",
    "DirectionalLight.lh":"res/3DScene/LayaScene_SampleScene/Conventional/DirectionalLight.lh",
    "lubiao.lh":"res/3DScene/LayaScene_SampleScene/Conventional/lubiao.lh",
    "LV1.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV1.lh",
    "LV10.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV10.lh",
    "LV11.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV11.lh",
    "LV12.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV12.lh",
    "LV13.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV13.lh",
    "LV14.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV14.lh",
    "LV15.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV15.lh",
    "LV16.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV16.lh",
    "LV17.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV17.lh",
    "LV18.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV18.lh",
    "LV19.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV19.lh",
    "LV2.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV2.lh",
    "LV20.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV20.lh",
    "LV21.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV21.lh",
    "LV22.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV22.lh",
    "LV23.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV23.lh",
    "LV24.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV24.lh",
    "LV25.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV25.lh",
    "LV26.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV26.lh",
    "LV27.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV27.lh",
    "LV28.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV28.lh",
    "LV29.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV29.lh",
    "LV3.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV3.lh",
    "LV30.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV30.lh",
    "LV4.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV4.lh",
    "LV5.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV5.lh",
    "LV6.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV6.lh",
    "LV7.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV7.lh",
    "LV8.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV8.lh",
    "LV9.lh":"res/3DScene/LayaScene_SampleScene/Conventional/LV9.lh",
    "MainCamera.lh":"res/3DScene/LayaScene_SampleScene/Conventional/MainCamera.lh",
    "MAP.lh":"res/3DScene/LayaScene_SampleScene/Conventional/MAP.lh",
    "NPC1.lh":"res/3DScene/LayaScene_SampleScene/Conventional/NPC1.lh",
    "NPC2.lh":"res/3DScene/LayaScene_SampleScene/Conventional/NPC2.lh",
    "NPC3.lh":"res/3DScene/LayaScene_SampleScene/Conventional/NPC3.lh",
    "SM_Prop_Barrier.lh":"res/3DScene/LayaScene_SampleScene/Conventional/SM_Prop_Barrier.lh",
    "SM_Prop_LightPole_Arm.lh":"res/3DScene/LayaScene_SampleScene/Conventional/SM_Prop_LightPole_Arm.lh",
    "SM_Prop_Sign_XXX.lh":"res/3DScene/LayaScene_SampleScene/Conventional/SM_Prop_Sign_XXX.lh",
    "start.lh":"res/3DScene/LayaScene_SampleScene/Conventional/start.lh",
    "xiaoche00.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche00.lh",
    "xiaoche1.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche1.lh",
    "xiaoche10.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche10.lh",
    "xiaoche2.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche2.lh",
    "xiaoche3.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche3.lh",
    "xiaoche4.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche4.lh",
    "xiaoche5.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche5.lh",
    "xiaoche6.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche6.lh",
    "xiaoche7.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche7.lh",
    "xiaoche8.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche8.lh",
    "xiaoche9.lh":"res/3DScene/LayaScene_SampleScene/Conventional/xiaoche9.lh",
    "yingdao.lh":"res/3DScene/LayaScene_SampleScene/Conventional/yingdao.lh",
    "zhangaiche1.lh":"res/3DScene/LayaScene_SampleScene/Conventional/zhangaiche1.lh",
    "zhangaiche2.lh":"res/3DScene/LayaScene_SampleScene/Conventional/zhangaiche2.lh",
    "zhangaiche3.lh":"res/3DScene/LayaScene_SampleScene/Conventional/zhangaiche3.lh"
};
let _ResPath = {"刹车.mp3":<any>null,"喇叭.mp3":<any>null,"引擎.mp3":<any>null,"背景音乐2.mp3":<any>null,"SampleSceneGIReflection.ltcb.ls":<Laya.Scene3D>null,"SampleScene.ls":<Laya.Scene3D>null,"Cube.lh":<Laya.Sprite3D>null,"DirectionalLight.lh":<Laya.Sprite3D>null,"lubiao.lh":<Laya.Sprite3D>null,"LV1.lh":<Laya.Sprite3D>null,"LV10.lh":<Laya.Sprite3D>null,"LV11.lh":<Laya.Sprite3D>null,"LV12.lh":<Laya.Sprite3D>null,"LV13.lh":<Laya.Sprite3D>null,"LV14.lh":<Laya.Sprite3D>null,"LV15.lh":<Laya.Sprite3D>null,"LV16.lh":<Laya.Sprite3D>null,"LV17.lh":<Laya.Sprite3D>null,"LV18.lh":<Laya.Sprite3D>null,"LV19.lh":<Laya.Sprite3D>null,"LV2.lh":<Laya.Sprite3D>null,"LV20.lh":<Laya.Sprite3D>null,"LV21.lh":<Laya.Sprite3D>null,"LV22.lh":<Laya.Sprite3D>null,"LV23.lh":<Laya.Sprite3D>null,"LV24.lh":<Laya.Sprite3D>null,"LV25.lh":<Laya.Sprite3D>null,"LV26.lh":<Laya.Sprite3D>null,"LV27.lh":<Laya.Sprite3D>null,"LV28.lh":<Laya.Sprite3D>null,"LV29.lh":<Laya.Sprite3D>null,"LV3.lh":<Laya.Sprite3D>null,"LV30.lh":<Laya.Sprite3D>null,"LV4.lh":<Laya.Sprite3D>null,"LV5.lh":<Laya.Sprite3D>null,"LV6.lh":<Laya.Sprite3D>null,"LV7.lh":<Laya.Sprite3D>null,"LV8.lh":<Laya.Sprite3D>null,"LV9.lh":<Laya.Sprite3D>null,"MainCamera.lh":<Laya.Sprite3D>null,"MAP.lh":<Laya.Sprite3D>null,"NPC1.lh":<Laya.Sprite3D>null,"NPC2.lh":<Laya.Sprite3D>null,"NPC3.lh":<Laya.Sprite3D>null,"SM_Prop_Barrier.lh":<Laya.Sprite3D>null,"SM_Prop_LightPole_Arm.lh":<Laya.Sprite3D>null,"SM_Prop_Sign_XXX.lh":<Laya.Sprite3D>null,"start.lh":<Laya.Sprite3D>null,"xiaoche00.lh":<Laya.Sprite3D>null,"xiaoche1.lh":<Laya.Sprite3D>null,"xiaoche10.lh":<Laya.Sprite3D>null,"xiaoche2.lh":<Laya.Sprite3D>null,"xiaoche3.lh":<Laya.Sprite3D>null,"xiaoche4.lh":<Laya.Sprite3D>null,"xiaoche5.lh":<Laya.Sprite3D>null,"xiaoche6.lh":<Laya.Sprite3D>null,"xiaoche7.lh":<Laya.Sprite3D>null,"xiaoche8.lh":<Laya.Sprite3D>null,"xiaoche9.lh":<Laya.Sprite3D>null,"yingdao.lh":<Laya.Sprite3D>null,"zhangaiche1.lh":<Laya.Sprite3D>null,"zhangaiche2.lh":<Laya.Sprite3D>null,"zhangaiche3.lh":<Laya.Sprite3D>null};
export const Package = {"3DScene":"3DScene","sounds":"sounds"};
export const ResGet = new Proxy(_ResPath, {
    get: function (target, propKey, receiver) {
        let result = Laya.loader.getRes(ResPath[propKey])
        return result ? result : null
    }
});
let VIEWJSONPATH = ["View_Game.json","View_GameOver.json","View_Loading.json","View_SelectLevel.json","View_Setting.json"];
//#endregion ////___AUTO_CONFIG_END___////

import Tools from "../ToolsCode/Toools";
class _LoadRes {
    /** 分包加载进度 */
    private PackageLoadNum: number = 0
    /** 加载任务数量 */
    private GetResState: number = 0
    /** 资源清单 */
    private ResList: string[] = []
    /** 是否初始化 */
    private IsInit: boolean = false

    init(ResFn?: Function, PackFn?: Function) {
        if (LoadRes.IsInit === false) {
            LoadRes.IsInit = true

            //预加载界面JSON文件
            LoadRes.load(VIEWJSONPATH, LoadRes, null, null, 0)

            //筛选资源路径
            for (let ResName in ResPath) {
                if (typeof ResFn == "function") {
                    if (ResFn(ResPath[ResName])) LoadRes.ResList.push(ResPath[ResName])
                } else {
                    LoadRes.ResList.push(ResPath[ResName])
                }
            }
            //筛选分包名字
            let PackageNameArr: string[] = [];
            for (let PackageName in Package) {
                if (typeof PackFn == "function") {
                    if (PackFn(Package[PackageName])) PackageNameArr.push(Package[PackageName])
                } else {
                    PackageNameArr.push(PackageName);
                }
            }
            LoadRes.DownloadAllPackage(PackageNameArr);
        }
    }

    /** 资源加载
 * @param url 资源地址的数组
 * @param caller 回调执行域(this)
 * @param complete 加载完成,如果全部加载成功，则回调参数的值为true，否则为false
 * @param progress 回调参数值为当前资源加载的进度信息(0-1)
 * @param priority (默认：1)加载的优先级，优先级高的优先加载。有0-4共5个优先级，0最高，4最低
 */
    load(url: string[] = [], caller = null, complete: Function = null, progress: Function = null, priority: number = 1) {
        Laya.loader.create(url,
            Laya.Handler.create(caller, complete),
            Laya.Handler.create(caller, progress),
            null, null, null, priority, true
        )
    }

    /** 分包加载 方法兼容各环境调用，但是暂时只会调用qq小游戏和微信小游戏的加载方法
     * @param url 包名的数组
     * @param caller 回调执行域(this)
     * @param complete 加载完成,如果全部加载成功，则回调参数的值为true，否则为false
     * @param progress 回调参数值为当前资源加载的进度信息(0-1)
     */
    loadPackage(name: string[] = [], caller = null, complete: Function = () => { }, progress: Function = () => { }) {
        //绑定作用域
        complete = complete.bind(caller);
        progress = progress.bind(caller);

        /** 执行加载分包的次数 */
        let _index = 0;

        /** 记录分包下载成功次数 */
        let _seccess = 0;

        /** 各个分包进度 */
        let _progress = [];

        //下载分包
        DownloadSubpackage()

        //监听进度，并返回进度
        Laya.timer.loop(100, LoadRes, AllLoadProgress)

        //===========================================================
        /** 执行下载分包 */
        function DownloadSubpackage() {
            //微信的分包下载
            if (Tools.getPlatform == "wx") {
                //判断是否还有分包未执行下载
                if (_index >= name.length) { return }

                //记录当前需要处理分包的下标
                let index = _index

                //初始化下载进度
                _progress[index] = 0

                //执行下载分包
                Laya.Browser.window.wx.loadSubpackage({
                    name: name[index],
                    success() {
                        let text = '分包[' + name[index] + ']加载成功'
                        console.info('%c' + text + '', 'color: #43bb88;font-size: 10px;');
                        _seccess++
                        _progress[index] = 1
                    },
                    fail(res) {
                        let text = '分包[' + name[index] + ']加载失败'
                        console.error('%c' + text + '', 'color: red;font-size: 14px;font-weight: bold;', res);
                        _progress[index] = 1
                    }
                })

                //监听下载进度(伪进度)
                Laya.timer.loop(100, LoadRes, LoadProgress)
                function LoadProgress() {
                    if (_progress[index] >= 0.95) {
                        Laya.timer.clear(LoadRes, LoadProgress)
                    } else if (_progress[index] >= 0.75) {
                        _progress[index] += 0.005
                    } else {
                        _progress[index] += 0.01
                    }
                }

                //执行下载下一个分包
                _index++
                DownloadSubpackage()
            } else {
                //判断是否还有分包未执行下载
                if (_index >= name.length) { return }

                //记录当前需要处理分包的下标
                let index = _index

                //初始化下载进度
                _progress[index] = 0

                //执行下载分包
                _seccess++
                _progress[index] = 1

                //监听下载进度(伪进度)
                Laya.timer.loop(100, LoadRes, LoadProgress)
                function LoadProgress() {
                    if (_progress[index] >= 0.95) {
                        Laya.timer.clear(LoadRes, LoadProgress)
                    } else if (_progress[index] >= 0.75) {
                        _progress[index] += 0.005
                    } else {
                        _progress[index] += 0.01
                    }
                }

                //执行下载下一个分包
                _index++
                DownloadSubpackage()
            }
        }

        /** 监听所有分包的下载进度 */
        function AllLoadProgress() {
            //计算所有分包总进度
            let All_progress = 0
            _progress.forEach((item) => {
                All_progress += item
            })
            All_progress = All_progress / name.length
            //返回进度
            progress(All_progress)
            //判断是否完成
            if (All_progress >= 1) {
                complete(_seccess == name.length)
                Laya.timer.clear(LoadRes, AllLoadProgress)
            }
        }
        //===========================================================

    }

    /** 执行下载分包 优先级：最高*/
    private DownloadAllPackage(PackageNameArr: string[] = []) {
        if (PackageNameArr.length >= 1) {
            LoadRes.loadPackage(PackageNameArr, LoadRes, (res) => {
                LoadRes.LoadRes()
            }, (res) => {
                LoadRes.PackageLoadNum = res
            });
        } else {
            LoadRes.PackageLoadNum = 1
            LoadRes.LoadRes()
        }

    }

    /** 执行加载资源  优先级：4*/
    private LoadRes() {
        let indexNum = 0
        load()
        function load() {
            if (LoadRes.ResList.length <= indexNum) {
                return
            }
            if (LoadRes.GetResState) {
                Laya.timer.frameOnce(100, LoadRes, load)
            } else if (Laya.loader.getRes(LoadRes.ResList[indexNum])) {
                indexNum++;
                Laya.timer.frameOnce(100, LoadRes, load)
            } else {
                LoadRes.load([LoadRes.ResList[indexNum]], LoadRes, (res) => {
                    indexNum++;
                    Laya.timer.frameOnce(100, LoadRes, load)
                }, null, 4)
            }
        }
    }

    /** 检验资源并返回进度，未加载资源提高优先级为 1 */
    ResState(resurlarr, caller, callback) {
        if (caller) callback = callback.bind(caller);
        LoadRes.init(); //如果调用了这方法还没有进行初始化 ，则自动调用初始化
        LoadRes.GetResState++
        //未加载清单
        let noLoadList: string[] = []
        let noLoadListProgress = 0
        resurlarr.forEach(item => {
            let result = Laya.loader.getRes(item)
            if (result == null) {
                noLoadList.push(item)
            }
        });
        //初始进度
        let progress = 1 - LoadRes.PackageLoadNum + 1 - noLoadListProgress

        // 等待分包下载完毕 才加载资源
        Laya.timer.frameLoop(1, LoadRes, load)
        function load() {
            if (LoadRes.PackageLoadNum >= 1 && noLoadList.length > 0) {
                Laya.timer.clear(LoadRes, load)
                LoadRes.load(noLoadList, LoadRes, (res) => {
                }, (res) => {
                    noLoadListProgress = res
                }, 1)
            } else if (noLoadList.length == 0) {
                noLoadListProgress = 1
                Laya.timer.clear(LoadRes, load)
            }
        }

        //返回资源加载进度
        Laya.timer.frameLoop(1, LoadRes, result)
        function result() {
            let _progress = 1 - (1 - LoadRes.PackageLoadNum + 1 - noLoadListProgress) / progress
            if (_progress >= 1) {
                LoadRes.GetResState--
                Laya.timer.clear(LoadRes, result)
            }
            callback(_progress)
        }
    }



}
export let LoadRes = new _LoadRes()

